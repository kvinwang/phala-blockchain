---
source: crates/pink/sidevm/macro/src/ocall.rs
assertion_line: 425
expression: "rustfmt_snippet::rustfmt_token_stream(&stream).unwrap()"
---
pub trait Ocall {
    fn call_slow(&self, a: i32, b: i32) -> i32;
    fn call_fi(&self, a: i32, b: i32) -> i32;
    fn call_fo(&self, a: i32, b: i32) -> i32;
    fn poll_fi_fo(&self, a: i32, b: i32) -> i32;
}
fn dispatch_call_fast<Env: Ocall + OcallEnv>(
    env: &mut Env,
    id: i32,
    p0: IntPtr,
    p1: IntPtr,
    p2: IntPtr,
    p3: IntPtr,
) -> IntPtr {
    match id {
        0 => {
            let buffer = match env.take_return() {
                Some(ret) => ret,
                None => return -1,
            };
            let len = p1 as usize;
            if buffer.len() != len {
                return -1;
            }
            env.copy_to_vm(&buffer, p0);
            len as IntPtr
        }
        104 => {
            let (a, b) = {
                let mut buf = env.slice_from_vm(p0, p1);
                match Decode::decode(&mut buf) {
                    Ok(p) => p,
                    Err(_) => return -1,
                }
            };
            env.call_fo(a, b) as _
        }
        102 => {
            let (a, b) = (p0 as _, p1 as _);
            env.poll_fi_fo(a, b) as _
        }
        _ => -1,
    }
}
fn dispatch_call_slow<Env: Ocall + OcallEnv>(
    env: &mut Env,
    id: i32,
    p0: IntPtr,
    p1: IntPtr,
    p2: IntPtr,
    p3: IntPtr,
) -> IntPtr {
    match id {
        0 => {
            let ret = {
                let buffer = match env.take_return() {
                    Some(ret) => ret,
                    None => return -1,
                };
                let len = p1 as usize;
                if buffer.len() != len {
                    return -1;
                }
                env.copy_to_vm(&buffer, p0);
                len as IntPtr
            };
            env.encode_put_return(&ret) as _
        }
        101 => {
            let (a, b) = {
                let mut buf = env.slice_from_vm(p0, p1);
                match Decode::decode(&mut buf) {
                    Ok(p) => p,
                    Err(_) => return -1,
                }
            };
            let ret = env.call_slow(a, b);
            env.encode_put_return(&ret) as _
        }
        103 => {
            let (a, b) = (p0 as _, p1 as _);
            let ret = env.call_fi(a, b);
            env.encode_put_return(&ret) as _
        }
        104 => {
            let (a, b) = {
                let mut buf = env.slice_from_vm(p0, p1);
                match Decode::decode(&mut buf) {
                    Ok(p) => p,
                    Err(_) => return -1,
                }
            };
            let ret = env.call_fo(a, b);
            env.encode_put_return(&ret) as _
        }
        102 => {
            let (a, b) = (p0 as _, p1 as _);
            let ret = env.poll_fi_fo(a, b);
            env.encode_put_return(&ret) as _
        }
        _ => {
            return -1;
        }
    }
}
pub trait OcallEnv {
    fn encode_put_return(&self, rv: impl Encode) -> usize;
    fn take_return(&self) -> Option<Vec<u8>>;
    fn copy_to_vm(&self, data: &[u8], ptr: IntPtr);
    fn slice_from_vm(&self, ptr: IntPtr, len: IntPtr) -> &[u8];
}
pub struct OcallImplement;
impl OcallImplement {
    pub fn call_slow(&self, a: i32, b: i32) -> i32 {
        unsafe {
            let inputs = (a, b);
            let mut input_buf = empty_buffer();
            Encode::encode_to(&inputs, &mut input_buf);
            let len = input_buf.len() as IntPtr;
            let ret = sidevm_ocall(101, input_buf.as_ptr() as IntPtr, len, 0, 0);
            let len = ret;
            if len < 0 {
                panic!("ocall returned an error");
            }
            let mut buf = alloc_buffer(len as _);
            let ret = sidevm_ocall_fast(0, buf.as_mut_ptr() as IntPtr, len, 0, 0);
            if ret != len {
                panic!("ocall get return length mismatch");
            }
            Decode::decode(&mut buf.as_ref()).expect("Failed to decode ocall return value")
        }
    }
    pub fn call_fi(&self, a: i32, b: i32) -> i32 {
        unsafe {
            let ret = sidevm_ocall(103, a as _, b as _, 0, 0);
            let len = ret;
            if len < 0 {
                panic!("ocall returned an error");
            }
            let mut buf = alloc_buffer(len as _);
            let ret = sidevm_ocall_fast(0, buf.as_mut_ptr() as IntPtr, len, 0, 0);
            if ret != len {
                panic!("ocall get return length mismatch");
            }
            Decode::decode(&mut buf.as_ref()).expect("Failed to decode ocall return value")
        }
    }
    pub fn call_fo(&self, a: i32, b: i32) -> i32 {
        unsafe {
            let inputs = (a, b);
            let mut input_buf = empty_buffer();
            Encode::encode_to(&inputs, &mut input_buf);
            let len = input_buf.len() as IntPtr;
            let ret = sidevm_ocall_fast(104, input_buf.as_ptr() as IntPtr, len, 0, 0);
            ret as _
        }
    }
    pub fn poll_fi_fo(&self, a: i32, b: i32) -> i32 {
        unsafe {
            let ret = sidevm_ocall_fast(102, a as _, b as _, 0, 0);
            ret as _
        }
    }
}

